# リアルタイムOCRアプリケーション

macOS上で動作するリアルタイムOCRシステムです。指定されたウィンドウ（iPhoneシミュレータやミラーリングアプリ）をキャプチャし、YOLOv8で小説リスト項目を検出、Tesseract OCRで日本語テキストを抽出し、CSV形式で保存します。

## 機能概要

- **リアルタイムウィンドウキャプチャ**: 指定したウィンドウを継続的にキャプチャ
- **YOLOv8物体検出**: 学習済みモデルでリスト項目を検出
- **日本語OCR**: Tesseract OCRで日本語テキストを抽出
- **重複排除**: 自動的に重複データを除外
- **CSV出力**: 抽出データをCSV形式で保存
- **リアルタイムプレビュー**: 検出結果を視覚的に確認

## システム要件

- **OS**: macOS 11.0 (Big Sur) 以降
- **CPU**: Apple Silicon (M1/M2/M3) または Intel
- **Python**: 3.9 以降
- **Tesseract OCR**: 4.0 以降

## インストール手順

### 1. Homebrewのインストール（未インストールの場合）

```bash
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
```

### 2. Tesseract OCRのインストール

```bash
brew install tesseract tesseract-lang
```

日本語言語データが含まれていることを確認:

```bash
tesseract --list-langs
```

出力に`jpn`が含まれていればOKです。

### 3. Python仮想環境の作成（推奨）

プロジェクト専用の仮想環境を作成することで、システムのPython環境に影響を与えずに依存関係を管理できます。

```bash
# 仮想環境を作成
python3 -m venv venv

# 仮想環境を有効化
source venv/bin/activate

# 仮想環境を無効化する場合（終了時）
deactivate
```

**注意**: 仮想環境は`.gitignore`に含まれており、Gitリポジトリには追加されません。

### 4. 依存関係のインストール

仮想環境を有効化した状態で、以下のコマンドを実行してください:

```bash
pip install --upgrade pip
pip install -r requirements.txt
```

### 5. YOLOv8モデルの配置

学習済みYOLOv8モデル（`best.pt`）を以下のパスに配置してください:

```
models/best.pt
```

または、設定ファイルでモデルパスを指定できます。

## macOS権限設定

このアプリケーションは画面をキャプチャするため、macOSの**画面収録権限**が必要です。

### 権限の付与手順

1. **システム環境設定**を開く
2. **セキュリティとプライバシー**を選択
3. **プライバシー**タブをクリック
4. 左側のリストから**画面収録**を選択
5. 鍵アイコンをクリックして変更を許可
6. **ターミナル**（またはPythonを実行するアプリ）にチェックを入れる
7. アプリケーションを再起動

### 権限が付与されていない場合

初回実行時に権限を求めるダイアログが表示されます。権限を付与後、アプリケーションを再起動してください。

## 使用方法

### GUIモード（推奨）

グラフィカルユーザーインターフェースを使用して、視覚的に操作できます。

```bash
# 仮想環境をアクティベート（作成した場合）
source venv/bin/activate

# GUIモードで起動
python src/gui_app.py
```

**GUIの機能**:
- **設定パネル**: ウィンドウタイトル、信頼度しきい値、OCR言語、出力パスなどを設定
- **制御パネル**: 
  - **ウィンドウ選択とプレビュー**: ウィンドウを選択して即座にプレビュー表示を開始
  - **開始/停止**: 物体検知とOCR処理の開始/停止（プレビューは継続）
  - **一時停止/再開**: 処理を一時停止/再開（プレビューは継続）
  - **CSV出力**: いつでもデータをCSVに出力
- **リアルタイムプレビュー**: キャプチャされた画面をリアルタイムで表示
  - プレビューモード: キャプチャのみ（物体検知なし）
  - 処理モード: キャプチャ + 物体検知 + OCR（緑色の矩形で検出結果を表示）
- **データログ**: 抽出されたテキストをリアルタイムで表示（新規/重複を色分け）
- **統計情報**: 抽出件数、処理フレーム数、検出数、実行時間を表示

**GUIの使い方**:
1. **ウィンドウを選択**: ドロップダウンから対象ウィンドウを選択（または手動入力）
2. **プレビュー開始**: 「ウィンドウを選択してプレビュー」ボタンをクリック
3. **処理開始**: プレビューが表示されたら「開始」ボタンをクリックして物体検知とOCRを開始
4. **一時停止**: 必要に応じて「一時停止」ボタンで処理を一時停止（プレビューは継続）
5. **停止**: 「停止」ボタンで処理を停止（プレビューは継続）
6. **プレビュー停止**: 「プレビューを停止」ボタンですべてを停止

**ステータス表示**:
- **停止中** (黒色): すべての処理が停止
- **プレビュー中** (青色): キャプチャのみ実行中
- **処理中** (緑色): キャプチャ + 物体検知 + OCR実行中
- **一時停止中** (オレンジ色): 処理が一時停止（プレビューは継続）

### CLIモード（コマンドライン）

従来のコマンドラインインターフェースでも実行できます。

```bash
# 仮想環境をアクティベート（作成した場合）
source venv/bin/activate

# CLIモードで実行
python src/realtime_ocr_app.py
```

### 設定のカスタマイズ

`src/config.py`で以下の設定を変更できます:

- **model_path**: YOLOv8モデルファイルのパス
- **target_window_title**: キャプチャ対象のウィンドウタイトル（部分一致）
- **confidence_threshold**: 検出の信頼度しきい値（0.0-1.0）
- **output_csv**: 出力CSVファイル名
- **ocr_lang**: OCR言語（デフォルト: `jpn`）

### 終了方法

**GUIモード**:
- **停止ボタン**: GUIの「停止」ボタンをクリック
- **ウィンドウを閉じる**: GUIウィンドウの閉じるボタン（×）をクリック
- **CSV出力ボタン**: 実行中でも「CSV出力」ボタンでいつでも保存可能

**CLIモード**:
- **'q'キー**: プレビューウィンドウで'q'キーを押すと終了
- **Ctrl+C**: ターミナルでCtrl+Cを押すと安全に終了

終了時に抽出されたデータが自動的にCSVファイルに保存されます。

## パフォーマンス最適化

このアプリケーションは、マルチスレッド処理とキャッシング機構により、高速なリアルタイムOCR処理を実現しています。

### パフォーマンスアーキテクチャ

アプリケーションは以下の並列処理パイプラインで動作します:

```
[キャプチャスレッド] → [検出スレッド] → [OCRワーカープール] → [表示スレッド]
        ↓                    ↓                    ↓
   フレームキュー        検出結果キュー        表示キュー
```

**主要な最適化技術**:
- **マルチスレッド処理**: キャプチャ、物体検出、OCR処理を並列実行
- **検出結果キャッシュ**: 類似フレームで物体検出をスキップ
- **OCR結果キャッシュ**: 同じ領域のOCR結果を再利用
- **並列OCR処理**: 複数の検出領域を同時にOCR処理
- **フレームスキップ**: 処理が追いつかない場合、古いフレームを破棄

### パフォーマンスモード

GUIモードでは、用途に応じて3つのパフォーマンスモードを選択できます:

#### 🚀 高速モード (Fast)
- **FPS目標**: 10-15 FPS
- **用途**: リアルタイム性を最優先する場合
- **特徴**:
  - 2フレームに1回処理（フレームスキップ有効）
  - 検出キャッシュとOCRキャッシュを積極的に使用
  - OCRワーカー数: 4
  - 最大検出数: 5件/フレーム
- **推奨環境**: Apple Silicon (M1/M2/M3)

#### ⚖️ バランスモード (Balanced) - デフォルト
- **FPS目標**: 5-10 FPS
- **用途**: 精度とパフォーマンスのバランスを取る場合
- **特徴**:
  - 全フレーム処理
  - 検出キャッシュとOCRキャッシュを使用
  - OCRワーカー数: 3
  - 最大検出数: 10件/フレーム
- **推奨環境**: すべての環境

#### 🎯 高精度モード (Accurate)
- **FPS目標**: 3-5 FPS
- **用途**: 精度を最優先する場合
- **特徴**:
  - 全フレーム処理
  - キャッシュを無効化（毎回検出とOCRを実行）
  - OCRワーカー数: 2
  - 最大検出数: 20件/フレーム
- **推奨環境**: 高性能なマシン

### パフォーマンスモードの選択方法

**GUIモード**:
1. GUIの設定パネルで「パフォーマンスモード」ドロップダウンを選択
2. 希望のモード（高速/バランス/高精度）を選択
3. 処理を開始すると、選択したモードで動作

**設定ファイル**:
`src/config.py`の`AppConfig`で以下を設定:
```python
performance_mode: str = "balanced"  # "fast", "balanced", "accurate"
```

### 期待されるパフォーマンス

| 環境 | 高速モード | バランスモード | 高精度モード |
|------|-----------|--------------|-------------|
| **Apple Silicon (M3 Pro)** | 12-15 FPS | 8-10 FPS | 4-6 FPS |
| **Apple Silicon (M1/M2)** | 10-12 FPS | 6-8 FPS | 3-5 FPS |
| **Intel Mac** | 8-10 FPS | 5-7 FPS | 2-4 FPS |

**注意**: 実際のFPSは以下の要因により変動します:
- ウィンドウサイズ（大きいほど処理時間が増加）
- 検出される項目数（多いほど処理時間が増加）
- 他のアプリケーションの負荷
- OCR言語データの複雑さ

### パフォーマンス統計の確認

GUIモードでは、リアルタイムでパフォーマンス統計を確認できます:

- **FPS**: 現在のフレームレート
- **処理フレーム数**: 処理されたフレームの総数
- **検出数**: 検出された項目の総数
- **実行時間**: 処理開始からの経過時間

### パフォーマンスチューニング

パフォーマンスをさらに向上させるためのヒント:

1. **信頼度しきい値を上げる**: 検出数を減らして処理を高速化
   ```python
   confidence_threshold: float = 0.7  # デフォルト: 0.6
   ```

2. **ウィンドウサイズを小さくする**: キャプチャ解像度を下げて処理を高速化

3. **不要なアプリケーションを閉じる**: CPUとメモリリソースを確保

4. **Apple Silicon環境でMPSを有効化**: YOLOv8がMetal Performance Shadersを使用
   ```python
   # 自動的に検出されますが、明示的に指定も可能
   device: str = "mps"  # Apple Silicon
   ```

5. **キャッシュTTLを調整**: キャッシュの有効期間を調整
   ```python
   # src/pipeline_processor.py
   self.detection_cache = DetectionCache(ttl=0.5)  # 秒単位
   ```

### トラブルシューティング: パフォーマンス

#### FPSが目標値に達しない

**原因と対策**:

1. **検出数が多すぎる**
   - 信頼度しきい値を上げる（0.7-0.8）
   - 高速モードに切り替える

2. **ウィンドウサイズが大きすぎる**
   - ウィンドウを小さくする
   - または、キャプチャ領域を制限する

3. **他のアプリケーションの負荷**
   - 不要なアプリケーションを閉じる
   - アクティビティモニタでCPU使用率を確認

4. **キャッシュが効いていない**
   - 画面が頻繁に変化している場合、キャッシュヒット率が低下
   - バランスモードまたは高速モードを試す

#### メモリ使用量が多い

**対策**:
- 最大検出数を制限する
- キャッシュTTLを短くする
- 高精度モードから他のモードに切り替える

#### 処理が遅延する

**対策**:
- フレームキューのサイズを調整（デフォルト: 2）
- OCRワーカー数を減らす（メモリ使用量とのトレードオフ）
- 高速モードに切り替える

## プロジェクト構造

```
.
├── src/                    # ソースコード
│   ├── gui_app.py          # GUIアプリケーション（推奨）
│   ├── realtime_ocr_app.py # CLIアプリケーション
│   ├── window_capture.py   # ウィンドウキャプチャモジュール
│   ├── object_detector.py  # YOLOv8物体検出モジュール
│   ├── ocr_processor.py    # OCRモジュール
│   ├── data_manager.py     # データ管理モジュール
│   ├── visualizer.py       # 可視化モジュール
│   ├── error_handler.py    # エラーハンドリングモジュール
│   ├── pipeline_processor.py # パイプライン処理モジュール
│   ├── performance_monitor.py # パフォーマンス計測モジュール
│   ├── detection_cache.py  # 検出結果キャッシュモジュール
│   ├── ocr_cache.py        # OCR結果キャッシュモジュール
│   ├── performance_mode.py # パフォーマンスモード設定
│   └── config.py           # 設定管理
├── config/                 # 設定ファイル（オプション）
│   └── config.example.yaml # サンプル設定ファイル
├── models/                 # YOLOv8モデルファイル
│   └── best.pt            # 学習済みモデル
├── output/                 # 出力ファイル
│   └── book_data_realtime.csv
├── tests/                  # テストコード
├── requirements.txt        # Python依存関係
└── README.md              # このファイル
```

## トラブルシューティング

### ウィンドウが見つからない

**エラー**: `Error: Window not found`

**解決策**:
1. ターゲットウィンドウが開いていることを確認
2. ウィンドウタイトルが正しいか確認（部分一致で検索されます）
3. 利用可能なウィンドウリストを確認して、正しいタイトルを指定

### Tesseractが見つからない

**エラー**: `TesseractNotFoundError`

**解決策**:
```bash
brew install tesseract tesseract-lang
```

インストール後、Tesseractのパスを確認:
```bash
which tesseract
```

### 画面収録権限エラー

**エラー**: 画面がキャプチャできない

**解決策**:
1. システム環境設定 > セキュリティとプライバシー > プライバシー > 画面収録
2. ターミナル（またはPythonアプリ）に権限を付与
3. アプリケーションを再起動

### モデルファイルが見つからない

**エラー**: `Model file not found`

**解決策**:
1. `best.pt`ファイルが`models/`ディレクトリに存在することを確認
2. または、`src/config.py`で正しいパスを指定

### OCR精度が低い

**対策**:
1. ウィンドウのサイズを大きくする
2. 画面の解像度を上げる
3. `ocr_margin`パラメータを調整（デフォルト: 5ピクセル）
4. 画像前処理を有効化（`OCRProcessor.preprocess_image()`）

### パフォーマンスが遅い

**対策**:
1. **パフォーマンスモードを変更**: GUIで「高速モード」に切り替える
2. `confidence_threshold`を上げて検出数を減らす（0.7-0.8推奨）
3. Apple Silicon環境でMPS（Metal Performance Shaders）が有効か確認
4. 不要なアプリケーションを閉じてリソースを確保
5. ウィンドウサイズを小さくする

詳細は「パフォーマンス最適化」セクションを参照してください。

### GUIが起動しない

**エラー**: `ModuleNotFoundError: No module named 'tkinter'`

**解決策**:
macOSの場合、Pythonに標準でtkinterが含まれていますが、Homebrewでインストールしたpython3の場合は以下を実行:
```bash
brew install python-tk@3.9  # または使用しているPythonバージョン
```

### データが重複して保存される

**問題**: 同じデータが複数回CSVに保存される

**解決策**:
- アプリケーションは自動的に重複を排除します
- GUIのデータログで重複データはグレー表示されます
- 既存のCSVファイルに追記する場合は、手動で重複を削除してください

## 開発情報

### 開発環境のセットアップ

開発時は必ず仮想環境を使用してください:

```bash
# 仮想環境を作成（初回のみ）
python3 -m venv venv

# 仮想環境を有効化
source venv/bin/activate

# 依存関係をインストール
pip install -r requirements.txt
```

### テストの実行

仮想環境を有効化した状態でテストを実行:

```bash
# 全テストを実行
pytest tests/ -v

# 特定のテストファイルを実行
pytest tests/test_object_detector.py -v

# カバレッジレポート付きで実行
pytest tests/ --cov=src --cov-report=html
```

または、仮想環境を有効化せずに直接実行:

```bash
./venv/bin/pytest tests/ -v
```

### コードフォーマット

```bash
black src/
```

### 型チェック

```bash
mypy src/
```

## ライセンス

このプロジェクトは個人使用を目的としています。

## サポート

問題が発生した場合は、以下を確認してください:
1. すべての依存関係が正しくインストールされているか
2. macOSの画面収録権限が付与されているか
3. YOLOv8モデルファイルが正しい場所に配置されているか
4. Tesseract OCRが正しくインストールされているか
