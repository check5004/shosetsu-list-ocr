# GUI動作確認ガイド（タスク14.3）

このドキュメントは、階層的検出機能のGUI動作確認手順を記載しています。

## テスト対象機能

1. モデル選択機能の動作確認
2. 画像フォルダを開く機能の動作確認
3. 統計情報の表示確認
4. 類似度しきい値スライダーの動作確認

## 前提条件

- 階層的検出モデル（`models/hierarchical_best.pt`）が存在すること
- テスト用のiPhoneシミュレータまたはミラーリングウィンドウが起動していること
- 仮想環境（venv）がアクティブであること

## テスト手順

### 1. GUIアプリケーションの起動

```bash
# 仮想環境をアクティブ化
source venv/bin/activate

# GUIアプリケーションを起動
python src/gui_app.py
```

### 2. モデル選択機能の動作確認（要件11.1, 11.2, 11.3）

#### 2.1 既存モデルの選択

1. GUIウィンドウの「モデル選択」セクションを確認
2. 「既存モデル（list-item全体）」ラジオボタンを選択
3. 「開始」ボタンをクリック
4. ログに「既存モードで処理を開始しました」と表示されることを確認

**期待される動作:**
- 既存のlist-item全体検出ロジックが使用される
- 統計情報に「検出数」が表示される
- CSV出力は従来形式（`book_data_realtime.csv`）

#### 2.2 階層的モデルの選択

1. 処理を停止（「停止」ボタンをクリック）
2. 「階層的モデル（5クラス）」ラジオボタンを選択
3. 「開始」ボタンをクリック
4. ログに「階層的検出モードで処理を開始しました」と表示されることを確認

**期待される動作:**
- 階層的検出ロジックが使用される
- 統計情報に各クラスの検出数が個別に表示される
- CSV出力は階層的形式（`output/hierarchical_data.csv`）

### 3. 統計情報の表示確認（要件11.4, 11.5）

#### 3.1 階層的モードでの統計情報

階層的モデルを選択して処理を開始した状態で、以下の統計情報が表示されることを確認:

- **list-item数**: 検出されたlist-itemの総数
- **title検出数**: titleが検出された数
- **progress検出数**: progressが検出された数
- **last_read_date検出数**: last_read_dateが検出された数
- **site_name検出数**: site_nameが検出された数
- **新規レコード数**: 重複を除いた新規データの数
- **エラー件数**: 必須項目が欠損しているレコードの数
- **正常件数**: すべての必須項目が揃っているレコードの数

**確認ポイント:**
- 各統計情報がリアルタイムで更新されること
- エラー件数と正常件数の合計が総レコード数と一致すること

#### 3.2 プレビュー表示の確認

1. 「プレビュー表示」チェックボックスをオンにする
2. プレビューウィンドウが表示されることを確認
3. 5クラスのbounding boxが異なる色で描画されることを確認:
   - list-item: 緑色
   - title: 青色
   - progress: 黄色
   - last_read_date: 赤色
   - site_name: マゼンタ色
4. 各bounding boxにクラスラベルが表示されることを確認

**期待される動作:**
- 各クラスが視覚的に区別できる
- 信頼度スコアが表示される
- フレームレートが表示される

### 4. 類似度しきい値スライダーの動作確認（要件7.10）

#### 4.1 スライダーの操作

1. 「類似度しきい値」スライダーを確認（範囲: 0.6〜0.9）
2. スライダーを動かして値を変更（例: 0.75 → 0.80）
3. 現在の値が右側に表示されることを確認
4. 処理を開始
5. ログに設定された類似度しきい値が表示されることを確認

**期待される動作:**
- スライダーの値がリアルタイムで表示される
- 設定した値が重複判定に使用される
- 類似度が高いほど、より厳密な重複判定が行われる

#### 4.2 重複判定の動作確認

1. 類似度しきい値を0.75に設定
2. 同じ画面を複数回スクロールして処理
3. ログに「重複検出」メッセージが表示されることを確認
4. 類似度スコアが表示されることを確認

**期待される動作:**
- OCRの誤認識を考慮した曖昧マッチングが機能する
- 類似度がしきい値以上の場合、重複と判定される
- 重複データは新規レコードとして追加されない

### 5. 画像フォルダを開く機能の動作確認（要件11.6, 11.7）

#### 5.1 画像フォルダを開くボタンの有効化

1. 階層的モデルを選択
2. 処理を開始
3. 「📁 画像フォルダを開く」ボタンが有効化されることを確認

**期待される動作:**
- 階層的モードで処理開始時にボタンが有効化される
- 既存モードではボタンは無効のまま

#### 5.2 Finderでフォルダを開く

1. 「📁 画像フォルダを開く」ボタンをクリック
2. macOSのFinderが起動することを確認
3. セッションフォルダ（`output/sessions/YYYYMMDD_HHMMSS/`）が開かれることを確認
4. フォルダ内に切り出された画像ファイルが存在することを確認

**期待される動作:**
- Finderが自動的に起動する
- 現在のセッションフォルダが表示される
- 画像ファイル名は`list_item_001.jpg`形式

#### 5.3 処理停止後のフォルダアクセス

1. 処理を停止
2. 「📁 画像フォルダを開く」ボタンが有効のまま（停止後もアクセス可能）
3. ボタンをクリックしてフォルダが開けることを確認

**期待される動作:**
- 停止後もフォルダにアクセスできる
- ZIP圧縮されたファイルも確認できる

### 6. エラーハンドリングの確認

#### 6.1 孤立要素の警告ログ

1. 処理中にログを監視
2. 「⚠️ 孤立した〇〇要素を検出」メッセージが表示されることを確認
3. 孤立要素の座標と信頼度が表示されることを確認

**期待される動作:**
- 親list-itemに紐付けられない子要素が検出された場合、警告が表示される
- 処理は継続される

#### 6.2 必須項目欠損の記録

1. 処理完了後、CSV出力を確認
2. `error_status`列に欠損情報が記録されていることを確認
3. 統計情報の「エラー件数」と一致することを確認

**期待される動作:**
- 必須項目（title、last_read_date、site_name）が欠損している場合、error_statusに記録される
- エラーがあってもレコードは保存される

### 7. CSV出力の確認

#### 7.1 階層的CSV出力

1. 処理を停止
2. `output/hierarchical_data.csv`ファイルが生成されることを確認
3. CSVファイルを開いて以下の列が存在することを確認:
   - list_item_id
   - title
   - progress
   - last_read_date
   - site_name
   - image_path
   - error_status

**期待される動作:**
- UTF-8エンコーディングで保存される
- 各list-itemが1行として記録される
- 画像パスは相対パス形式

#### 7.2 統計情報の表示

1. ログに以下の統計情報が表示されることを確認:
   - 総件数
   - 正常件数
   - エラー件数
   - エラー内訳（missing_title等）

**期待される動作:**
- 統計情報が正確に計算される
- エラー内訳が詳細に表示される

### 8. セッション管理の確認

#### 8.1 セッションフォルダの作成

1. 処理開始時にログを確認
2. 「📁 セッション開始: output/sessions/YYYYMMDD_HHMMSS」と表示されることを確認
3. フォルダが実際に作成されることを確認

**期待される動作:**
- タイムスタンプベースのフォルダが作成される
- フォルダ名は`YYYYMMDD_HHMMSS`形式

#### 8.2 ZIP圧縮の確認

1. 処理を停止
2. ログに「🗜️ セッションフォルダを圧縮中」と表示されることを確認
3. `output/sessions/YYYYMMDD_HHMMSS.zip`ファイルが生成されることを確認
4. ZIPファイルを解凍して画像ファイルが含まれることを確認

**期待される動作:**
- セッションフォルダがZIP圧縮される
- 元のフォルダは保持される（削除されない）
- ZIPファイルに全画像が含まれる

## テスト結果の記録

### チェックリスト

- [ ] 1. モデル選択機能（既存モデル）
- [ ] 2. モデル選択機能（階層的モデル）
- [ ] 3. 統計情報の表示（各クラスの検出数）
- [ ] 4. 統計情報の表示（エラー件数・正常件数）
- [ ] 5. プレビュー表示（5クラスの色分け）
- [ ] 6. 類似度しきい値スライダーの操作
- [ ] 7. 重複判定の動作
- [ ] 8. 画像フォルダを開くボタンの有効化
- [ ] 9. Finderでフォルダを開く
- [ ] 10. 処理停止後のフォルダアクセス
- [ ] 11. 孤立要素の警告ログ
- [ ] 12. 必須項目欠損の記録
- [ ] 13. CSV出力（階層的形式）
- [ ] 14. 統計情報の表示（CSV出力時）
- [ ] 15. セッションフォルダの作成
- [ ] 16. ZIP圧縮

### 発見された問題

（テスト実施時に記録）

## トラブルシューティング

### 問題: 階層的モデルが見つからない

**解決策:**
```bash
# モデルを学習
python train_hierarchical_model.py
```

### 問題: 画像フォルダを開くボタンが無効

**原因:**
- 既存モードで処理している
- 処理が開始されていない

**解決策:**
- 階層的モデルを選択して処理を開始

### 問題: 統計情報が更新されない

**原因:**
- 検出結果がない
- ウィンドウが見つからない

**解決策:**
- iPhoneシミュレータまたはミラーリングウィンドウを起動
- ウィンドウタイトルに"iPhone"が含まれることを確認

### 問題: Finderが開かない

**原因:**
- macOS以外の環境で実行している
- セッションフォルダが存在しない

**解決策:**
- macOS環境で実行
- 処理を開始してセッションフォルダを作成

## 参考情報

### 要件との対応

- **要件11.1**: モデル選択オプションの提供
- **要件11.2**: 新モデル選択時の階層的検出ロジック有効化
- **要件11.3**: 既存モデル選択時の従来ロジック使用
- **要件11.4**: 構造化されたCSV出力の生成
- **要件11.5**: 各クラスの検出数の個別表示
- **要件11.6**: 「画像フォルダを開く」ボタンの設置
- **要件11.7**: Finderでセッションフォルダを開く
- **要件7.10**: 類似度しきい値の設定可能化

### 関連ファイル

- `src/gui_app.py`: GUIアプリケーション本体
- `src/hierarchical_pipeline.py`: 階層的検出パイプライン
- `src/hierarchical_detector.py`: 階層的検出器
- `src/hierarchical_data_manager.py`: データ管理
- `src/session_manager.py`: セッション管理
- `src/config.py`: 設定管理
