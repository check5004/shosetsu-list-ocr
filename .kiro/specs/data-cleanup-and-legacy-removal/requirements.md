# Requirements Document

## Introduction

このスペックは、リアルタイムOCRアプリケーションの2つの主要な改善を実装します：
1. 既存モデル（legacy mode）の完全削除とコードベースのクリーンアップ
2. 抽出データの人間による確認・編集機能の追加

既存モデルは階層的検出モデルに完全に置き換えられたため、関連するすべてのコード、UI要素、設定を削除します。また、抽出された小説データを本棚のように表示し、ユーザーが誤字修正、重複削除、データ補完を行える新しいGUI機能を追加します。

## Glossary

- **System**: リアルタイムOCRアプリケーション
- **Legacy Mode**: 既存の単一ラベル検出モード（list-item全体を1つとして検出）
- **Hierarchical Mode**: 階層的検出モード（list-item内の詳細要素を個別に検出）
- **Data Editor**: 抽出データの確認・編集機能を提供するGUIコンポーネント
- **Record**: 1つの小説作品に対応するデータレコード
- **Confirmed Record**: ユーザーが確認済みとしてロックしたレコード
- **OCR Text**: OCRによって抽出されたテキスト
- **Newline Artifact**: OCR時に元アプリのUI上の改行が保持されてしまう不要な改行

## Requirements

### Requirement 1: 既存モデル（Legacy Mode）の完全削除

**User Story:** 開発者として、既存モデルが完全に削除され、階層的モデルのみが使用されるようにしたい。これにより、コードベースがシンプルになり、保守性が向上する。

#### Acceptance Criteria

1. システムが起動するとき、システムは階層的検出モデルのみを使用すること
2. システムはコードベースからlegacy mode関連のすべてのコードを削除すること
3. システムはGUIからlegacy mode関連のすべてのUI要素を削除すること
4. システムはAppConfigからlegacy mode関連のすべての設定オプションを削除すること
5. システムはlegacy mode関連のすべてのインポートと依存関係を削除すること
6. システムはlegacy modeの削除を反映するようにドキュメントを更新すること
7. システムはコードベースに"legacy"、"既存モデル"、"best.pt"への参照が残っていないことを保証すること

### Requirement 2: OCRテキストの改行アーティファクト除去

**User Story:** ユーザーとして、OCRで抽出されたタイトルから元アプリのUI上の不要な改行が除去されることを期待する。これにより、データの品質が向上する。

#### Acceptance Criteria

1. システムがOCRでテキストを抽出するとき、システムはtitleフィールドから改行文字を削除すること
2. システムは連続する複数のスペースを1つのスペースに正規化すること
3. システムは改行削除後もテキストの意味を保持すること
4. システムはtitleフィールドのみに改行削除を適用すること

### Requirement 3: データエディターGUIの基本構造

**User Story:** ユーザーとして、抽出された小説データを表形式で閲覧できるGUIが欲しい。これにより、データの全体像を把握できる。

#### Acceptance Criteria

1. システムはデータエディターGUIコンポーネントを提供すること
2. システムは抽出されたレコードを表形式で表示すること
3. システムはtitle、progress、last_read_date、site_name、error_status、confirmation_statusの列を表示すること
4. レコード数が表示領域を超えるとき、システムはスクロールをサポートすること
5. 新しいレコードが追加されるとき、システムはテーブル表示をリアルタイムで更新すること
6. システムはメインGUIからデータエディターにアクセスする方法を提供すること

### Requirement 4: レコードの編集機能

**User Story:** ユーザーとして、表示されたレコードの各フィールドを直接編集できるようにしたい。これにより、OCRの誤認識を修正できる。

#### Acceptance Criteria

1. ユーザーがテーブルセルをダブルクリックするとき、システムはそのセルのインライン編集を有効にすること
2. ユーザーがセルの編集を完了するとき、システムは変更を基礎データに保存すること
3. システムは保存前に編集されたデータを検証すること
4. セルが編集されているとき、システムは視覚的フィードバックを提供すること
5. システムはtitle、progress、last_read_date、site_nameフィールドの編集をサポートすること
6. 明示的にロック解除されない限り、システムは確定済みレコードの編集を防止すること

### Requirement 5: レコードの削除機能

**User Story:** ユーザーとして、重複データや不要なレコードを削除できるようにしたい。これにより、データの品質を維持できる。

#### Acceptance Criteria

1. システムは各レコード行に削除ボタンを提供すること
2. ユーザーが削除ボタンをクリックするとき、システムは確認プロンプトを表示すること
3. ユーザーが削除を確認するとき、システムはデータマネージャーからレコードを削除すること
4. 削除後、システムはテーブル表示を更新すること
5. システムはバッチ操作のための複数選択削除をサポートすること
6. 明示的にロック解除されない限り、システムは確定済みレコードの削除を防止すること

### Requirement 6: レコードの確定（ロック）機能

**User Story:** ユーザーとして、確認済みのレコードを「確定」としてロックできるようにしたい。これにより、誤って編集や削除することを防げる。

#### Acceptance Criteria

1. システムは各レコードに確認チェックボックスまたはボタンを提供すること
2. ユーザーがレコードを確定済みとしてマークするとき、システムはレコードを編集と削除からロックすること
3. ユーザーがレコードを確定済みとしてマークするとき、システムは類似度の高い重複候補レコードが存在するか確認すること
4. 重複候補が存在するとき、システムは重複削除モーダルを表示すること
5. 重複削除モーダルでは、システムは確定するレコードと類似する重複候補を一覧表示すること
6. 重複削除モーダルでは、ユーザーが重複候補を選択して一括削除できるようにすること
7. 重複削除モーダルでは、ユーザーが確定するレコードのデータを修正できるようにすること
8. システムは確定済みレコードに視覚的表示を提供すること（例：異なる背景色）
9. 必要に応じて、システムは確定済みレコードをロック解除する方法を提供すること
10. CSVエクスポート時、システムは確認ステータスを保持すること
11. システムはCSVエクスポートに"confirmed"列を追加すること

### Requirement 7: データのソート機能

**User Story:** ユーザーとして、レコードを様々な基準でソートできるようにしたい。これにより、特定のレコードを素早く見つけられる。

#### Acceptance Criteria

1. システムはソート可能なクリック可能な列ヘッダーを提供すること
2. ユーザーが列ヘッダーをクリックするとき、システムはその列で昇順にレコードをソートすること
3. ユーザーが同じ列ヘッダーを再度クリックするとき、システムは降順にソートすること
4. システムはtitle、progress、last_read_date、site_name、error_status、confirmation_statusによるソートをサポートすること
5. システムは現在のソート列と方向の視覚的表示を提供すること
6. 新しいレコードが追加されるとき、システムはソート順を維持すること

### Requirement 8: エラーステータスによるフィルタリング

**User Story:** ユーザーとして、エラーステータス（情報不足）のレコードのみを表示できるようにしたい。これにより、修正が必要なレコードに集中できる。

#### Acceptance Criteria

1. システムはerror_statusのフィルターオプションを提供すること
2. システムは"すべて"、"エラーのみ"、"エラーなし"、"未確認"によるフィルタリングをサポートすること
3. ユーザーがフィルターを選択するとき、システムは一致するレコードのみを表示するようにテーブルを更新すること
4. システムはフィルタリングされたレコードの数を表示すること
5. 新しいレコードが追加されるとき、システムはフィルター状態を維持すること

### Requirement 9: データエディターとメインGUIの統合

**User Story:** ユーザーとして、メインGUIからデータエディターを簡単に開けるようにしたい。これにより、シームレスなワークフローが実現できる。

#### Acceptance Criteria

1. システムはメインGUIにデータエディターを開くボタンを提供すること
2. データエディターが開かれるとき、システムはデータマネージャーから現在のレコードをロードすること
3. システムはデータエディターを別ウィンドウで実行できるようにすること
4. システムはメインGUIとデータエディター間でデータをリアルタイムで同期すること
5. システムはユーザーがデータを失うことなくデータエディターを閉じて再度開けるようにすること

### Requirement 10: 編集データのCSVエクスポートとインポート

**User Story:** ユーザーとして、編集後のデータをCSVファイルにエクスポートし、後で再度インポートして編集を続けられるようにしたい。これにより、作業を中断して後で再開できる。

#### Acceptance Criteria

1. システムはデータエディターにエクスポートボタンを提供すること
2. ユーザーがエクスポートをクリックするとき、システムはすべてのレコード（編集を含む）をCSVに保存すること
3. システムはCSVエクスポートに確認ステータスを含めること
4. システムは互換性のために元のCSV形式を保持すること
5. システムはエクスポート成功時にフィードバックを提供すること
6. システムはデータエディターにインポートボタンを提供すること
7. ユーザーがインポートをクリックするとき、システムはCSVファイル選択ダイアログを表示すること
8. システムは選択されたCSVファイルからレコードをロードすること
9. システムはインポート時に確認ステータスを含むすべてのフィールドを復元すること
10. システムはインポート時にデータ検証を実行すること
11. システムはインポート成功時にフィードバックを提供すること
12. インポート時に既存データが存在する場合、システムはユーザーに上書き確認を求めること

### Requirement 11: データエディターのUX改善

**User Story:** ユーザーとして、データエディターが使いやすく、視覚的にわかりやすいことを期待する。

#### Acceptance Criteria

1. システムは確定済み、エラー、通常のレコードを区別するためにカラーコーディングを使用すること
2. システムはボタンとインタラクティブ要素にツールチップを提供すること
3. システムは統計情報（総レコード数、確定済み、エラー、未確認）を表示すること
4. システムは一般的な操作のためのキーボードショートカットを提供すること
5. システムはデータ損失を防ぐために編集を自動保存すること
6. システムは最近の編集のためのアンドゥ機能を提供すること

### Requirement 12: コードベースのクリーンアップと検証

**User Story:** 開発者として、既存モデル削除後のコードベースが正常に動作することを確認したい。

#### Acceptance Criteria

1. legacy mode削除後、システムはすべての既存テストに合格すること
2. legacy modeコードが削除されたとき、システムはエラーなしで起動すること
3. システムはlegacyコンポーネントを参照せずに階層的検出を実行すること
4. システムはlegacy modeに関連する未使用のインポートやデッドコードを持たないこと
5. システムは変更を反映した更新されたドキュメントを持つこと
